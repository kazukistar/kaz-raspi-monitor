<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, viewport-fit=cover" />
  <title>KAZ-RASPI / STATUS</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Share+Tech+Mono&family=Noto+Serif+JP:wght@700;900&display=swap" rel="stylesheet">
  <!-- DSEG 7-seg -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/keshikan/DSEG@v0.46.0/css/dseg.css">

  <style>
    :root{
      --evaY:#FFC400;
      --evaY2:#FFB100;
      --line1: rgba(255,196,0,.95);
      --line2: rgba(255,196,0,.30);
      --fill1: rgba(255,196,0,.14);
      --fill2: rgba(255,196,0,.02);

      --bg0:#020305;
      --bg1:#06070a;

      --text: rgba(255,240,210,.95);
      --muted: rgba(255,240,210,.70);

      --warn:#FF2A2A;
      --caution:#FF6A2B;

      --pad:14px;
      --gap:18px;

      /* FIXED safe rect inside hex (px, not %) */
      --safe-top: 56px;
      --safe-bottom: 92px;
      --safe-left: 48px;
      --safe-right: 48px;
    }

    *{ box-sizing:border-box; }
    html,body{
      width:100%; height:100%; margin:0;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,196,0,.12), transparent 62%),
        radial-gradient(900px 600px at 80% 80%, rgba(255,42,42,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow:hidden;
    }

    /* Font sets */
    .en{ font-family:"Rajdhani", system-ui, sans-serif; letter-spacing:.22em; text-transform:uppercase; }
    .mono{ font-family:"Share Tech Mono", ui-monospace, monospace; letter-spacing:.14em; text-transform:uppercase; }
    .jp{ font-family:"Noto Serif JP", serif; font-weight:900; letter-spacing:.18em; }

    /* FORCE 7seg for numbers (iOS対策: !important) */
    .seg{
      font-family:"DSEG7Classic","DSEG7ClassicMini","DSEG7ClassicBold","Share Tech Mono", monospace !important;
      font-weight:400 !important;
      letter-spacing:.06em;
      font-variant-ligatures:none;
    }

    .frame{
      height:100%;
      width:100%;
      padding:
        calc(var(--pad) + env(safe-area-inset-top))
        calc(var(--pad) + env(safe-area-inset-right))
        calc(var(--pad) + env(safe-area-inset-bottom))
        calc(var(--pad) + env(safe-area-inset-left));
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      overflow:auto;

      /* optional: EVAっぽく「パネル単位」で止まる */
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }

    /* Header */
    .header{
      position:relative;
      border:1px solid rgba(255,196,0,.28);
      background: linear-gradient(90deg, rgba(255,196,0,.14), rgba(255,196,0,.02));
      padding:12px 14px;
      box-shadow: 0 0 30px rgba(255,196,0,.10);
      scroll-snap-align: start;
    }
    .header::before{
      content:"";
      position:absolute;
      inset:-2px;
      border:1px solid rgba(255,196,0,.12);
      pointer-events:none;
    }
    .hrow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title{
      font-size:22px;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border:1px solid rgba(255,196,0,.62);
      background: rgba(255,196,0,.06);
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--evaY);
      box-shadow:0 0 16px rgba(255,196,0,.22);
    }
    .sub{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted);
    }

    /* ===== HEX TILE (FIXED HEIGHT so never clipped) ===== */
    .tile{
      position:relative;
      width:min(92vw, 420px);
      height:min(78vh, 520px);     /* <-- key: lock height */
      margin:0 auto 24px auto;
      filter: drop-shadow(0 0 14px rgba(255,196,0,.12));
      scroll-snap-align: start;
    }

    svg.hex{
      position:absolute; inset:0;
      width:100%; height:100%;
    }

    /* safe box: GRID + px inset; overflow hidden => no bleed */
    .safe{
      position:absolute;
      inset: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
      display:grid;
      grid-template-rows: min-content 1fr min-content; /* title / value / bottom */
      gap:10px;
      align-items:center;
      text-align:center;
      overflow:hidden;
    }

    /* Title bigger */
    .metricTitle{
      font-size: clamp(22px, 4.4vw, 30px);
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Value block */
    .valBox{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height:0;
    }

    /* BIG number: prevent DSEG vertical overflow */
    .big{
      font-size: clamp(56px, 12vw, 96px);
      line-height: 0.90;         /* <-- key */
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-height: 1em;           /* <-- key */
      text-shadow: 0 0 26px rgba(255,196,0,.14);
    }
    .unit{
      font-size:.32em;
      margin-left:10px;
      color: rgba(255,196,0,.98);
      vertical-align: top;
      position: relative;
      top: -0.15em;              /* <-- key */
    }
    .enLabel{
      font-size:12px;
      color: rgba(255,240,210,.72);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Bottom row: gauge + status */
    .bottom{
      display:grid;
      grid-template-columns: 90px 1fr;
      gap:12px;
      align-items:center;
      min-height:86px;
      border-top:1px dashed rgba(255,196,0,.18);
      padding-top:12px;
    }
    .statusLines{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      color: rgba(255,240,210,.80);
      min-width:0;
    }
    .sline{
      display:flex;
      justify-content:space-between;
      gap:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Gauge */
    .gauge{
      width:86px; height:86px;
      position:relative;
      justify-self:center;
    }
    .gauge svg{ width:100%; height:100%; transform: rotate(-90deg); }
    .gBg{ stroke: rgba(255,196,0,.16); stroke-width:10; fill:none; }
    .gFg{
      stroke: rgba(255,196,0,.92);
      stroke-width:10;
      fill:none;
      stroke-linecap:round;
      stroke-dasharray:0 999;
      transition: stroke-dasharray .45s ease, stroke .45s ease;
    }
    .gTxt{
      position:absolute; inset:0;
      display:grid; place-items:center;
      font-size:16px;
      color: rgba(255,240,210,.86);
    }

    /* Storage bars + services list */
    .bars{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }
    .bar{
      height:12px;
      border:1px solid rgba(255,196,0,.32);
      background: rgba(255,196,0,.06);
      position:relative;
      overflow:hidden;
    }
    .bar i{
      position:absolute; inset:0;
      width:40%;
      background: linear-gradient(90deg, rgba(255,196,0,.84), rgba(255,196,0,.20));
      transition: width .45s ease;
      display:block;
    }

    .svc{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(255,196,0,.18);
      display:flex;
      flex-direction:column;
      gap:10px;
      font-size:12px;
      color: rgba(255,240,210,.82);
    }
    .svcLine{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .svcName{
      text-transform:uppercase;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .svcState{
      padding:2px 8px;
      border:1px solid rgba(255,196,0,.30);
      background: rgba(255,196,0,.06);
      white-space:nowrap;
    }

    /* dummy hex column (background stack) */
    .ghostCol{
      width:min(92vw, 420px);
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      opacity:.22;
      pointer-events:none;
      scroll-snap-align: start;
    }
    .ghost{
      position:relative;
      width:100%;
      height:min(78vh, 520px); /* match tile height */
      filter: drop-shadow(0 0 10px rgba(255,196,0,.06));
    }

    /* Severity */
    .sev-ok{
      --stroke: rgba(255,196,0,.95);
      --stroke2: rgba(255,196,0,.30);
      --f1: rgba(255,196,0,.14);
      --f2: rgba(255,196,0,.02);
      --g: rgba(255,196,0,.92);
    }
    .sev-caution{
      --stroke: rgba(255,106,43,.95);
      --stroke2: rgba(255,106,43,.28);
      --f1: rgba(255,106,43,.14);
      --f2: rgba(255,106,43,.02);
      --g: rgba(255,106,43,.95);
    }
    .sev-warn{
      --stroke: rgba(255,42,42,.96);
      --stroke2: rgba(255,42,42,.30);
      --f1: rgba(255,42,42,.16);
      --f2: rgba(255,42,42,.02);
      --g: rgba(255,42,42,.96);
      animation:pulse 1.1s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ filter: drop-shadow(0 0 14px rgba(255,42,42,.14)); }
      50%{ filter: drop-shadow(0 0 32px rgba(255,42,42,.22)); }
    }

    /* Hex outline */
    .hexOuter{ stroke: var(--stroke); stroke-width:2.2; }
    .hexInner{ stroke: var(--stroke2); stroke-width:1.3; }
    .hexFill{ fill: url(#grad); }

    /* vignette */
    .vignette{
      position:fixed; inset:0;
      pointer-events:none;
      background: radial-gradient(60% 60% at 50% 40%, transparent 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.60) 100%);
      mix-blend-mode: multiply;
    }
  </style>
</head>

<body>
  <div class="frame">

    <div class="header">
      <div class="hrow">
        <div class="title en">KAZ-RASPI</div>
        <div class="pill">
          <span class="dot"></span>
          <span class="en" style="font-size:14px;">SYSTEM / ONLINE</span>
        </div>
      </div>
      <div class="sub mono">
        <span>SERVER STATUS MONITOR</span>
        <span>UPDATE: <b id="updateAge">1.0</b> S</span>
      </div>
    </div>

    <!-- background dummy hex stack -->
    <div class="ghostCol" aria-hidden="true">
      <div class="ghost">
        <svg class="hex" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
          <polygon points="50,2 93,25 93,75 50,98 7,75 7,25" fill="rgba(255,196,0,.03)" stroke="rgba(255,196,0,.22)" stroke-width="2"/>
          <polygon points="50,6 89,27.5 89,72.5 50,94 11,72.5 11,27.5" fill="none" stroke="rgba(255,196,0,.10)" stroke-width="1.2"/>
        </svg>
      </div>
      <div class="ghost">
        <svg class="hex" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
          <polygon points="50,2 93,25 93,75 50,98 7,75 7,25" fill="rgba(255,196,0,.03)" stroke="rgba(255,196,0,.22)" stroke-width="2"/>
          <polygon points="50,6 89,27.5 89,72.5 50,94 11,72.5 11,27.5" fill="none" stroke="rgba(255,196,0,.10)" stroke-width="1.2"/>
        </svg>
      </div>
      <div class="ghost">
        <svg class="hex" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
          <polygon points="50,2 93,25 93,75 50,98 7,75 7,25" fill="rgba(255,196,0,.03)" stroke="rgba(255,196,0,.22)" stroke-width="2"/>
          <polygon points="50,6 89,27.5 89,72.5 50,94 11,72.5 11,27.5" fill="none" stroke="rgba(255,196,0,.10)" stroke-width="1.2"/>
        </svg>
      </div>
    </div>

    <!-- CPU TEMP -->
    <section class="tile sev-ok" id="tempTile">
      <svg class="hex" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="grad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="var(--f1)"/>
            <stop offset="1" stop-color="var(--f2)"/>
          </linearGradient>
        </defs>
        <polygon class="hexFill" points="50,2 93,25 93,75 50,98 7,75 7,25"></polygon>
        <polygon class="hexOuter" points="50,2 93,25 93,75 50,98 7,75 7,25" fill="none"></polygon>
        <polygon class="hexInner" points="50,6 89,27.5 89,72.5 50,94 11,72.5 11,27.5" fill="none"></polygon>
      </svg>

      <div class="safe">
        <div class="metricTitle jp">CPU温度</div>

        <div class="valBox">
          <div class="big seg"><span id="cpuTemp">58</span><span class="unit">℃</span></div>
          <div class="enLabel mono">CPU TEMP</div>
        </div>

        <div class="bottom">
          <div class="gauge">
            <svg viewBox="0 0 100 100">
              <circle class="gBg" cx="50" cy="50" r="38"></circle>
              <circle class="gFg" id="gTemp" cx="50" cy="50" r="38"></circle>
            </svg>
            <div class="gTxt en"><span id="gTempP">--</span>%</div>
          </div>
          <div class="statusLines mono">
            <div class="sline"><span>STATUS</span><span><b id="tempState">NORMAL</b></span></div>
            <div class="sline"><span>TH</span><span><b>60</b>/<b>75</b></span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CPU UTIL -->
    <section class="tile sev-ok" id="cpuTile">
      <svg class="hex" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="grad2" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="var(--f1)"/>
            <stop offset="1" stop-color="var(--f2)"/>
          </linearGradient>
        </defs>
        <polygon points="50,2 93,25 93,75 50,98 7,75 7,25" fill="url(#grad2)"></polygon>
        <polygon class="hexOuter" points="50,2 93,25 93,75 50,98 7,75 7,25" fill="none"></polygon>
        <polygon class="hexInner" points="50,6 89,27.5 89,72.5 50,94 11,72.5 11,27.5" fill="none"></polygon>
      </svg>

      <div class="safe">
        <div class="metricTitle jp">CPU稼働率</div>

        <div class="valBox">
          <div class="big seg"><span id="cpuUtil">41</span><span class="unit">%</span></div>
          <div class="enLabel mono">CPU UTILIZATION</div>
        </div>

        <div class="bottom">
          <div class="gauge">
            <svg viewBox="0 0 100 100">
              <circle class="gBg" cx="50" cy="50" r="38"></circle>
              <circle class="gFg" id="gCPU" cx="50" cy="50" r="38"></circle>
            </svg>
            <div class="gTxt en"><span id="gCPUP">--</span>%</div>
          </div>
          <div class="statusLines mono">
            <div class="sline"><span>STATUS</span><span><b id="cpuState">NORMAL</b></span></div>
            <div class="sline"><span>LOAD</span><span><b id="loadAvg">0.74</b></span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RAM UTIL -->
    <section class="tile sev-ok" id="ramTile">
      <svg class="hex" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="grad3" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="var(--f1)"/>
            <stop offset="1" stop-color="var(--f2)"/>
          </linearGradient>
        </defs>
        <polygon points="50,2 93,25 93,75 50,98 7,75 7,25" fill="url(#grad3)"></polygon>
        <polygon class="hexOuter" points="50,2 93,25 93,75 50,98 7,75 7,25" fill="none"></polygon>
        <polygon class="hexInner" points="50,6 89,27.5 89,72.5 50,94 11,72.5 11,27.5" fill="none"></polygon>
      </svg>

      <div class="safe">
        <div class="metricTitle jp">メモリ稼働率</div>

        <div class="valBox">
          <div class="big seg"><span id="ramUtil">63</span><span class="unit">%</span></div>
          <div class="enLabel mono">MEMORY UTILIZATION</div>
        </div>

        <div class="bottom">
          <div class="gauge">
            <svg viewBox="0 0 100 100">
              <circle class="gBg" cx="50" cy="50" r="38"></circle>
              <circle class="gFg" id="gRAM" cx="50" cy="50" r="38"></circle>
            </svg>
            <div class="gTxt en"><span id="gRAMP">--</span>%</div>
          </div>
          <div class="statusLines mono">
            <div class="sline"><span>USED</span><span><b id="ramUsed">2.6</b>/<b id="ramTotal">4.0</b>GB</span></div>
            <div class="sline"><span>UPTIME</span><span><b id="uptime">00:00:00</b></span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- NET SPEED -->
    <section class="tile sev-ok" id="netTile">
      <svg class="hex" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="grad4" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="var(--f1)"/>
            <stop offset="1" stop-color="var(--f2)"/>
          </linearGradient>
        </defs>
        <polygon points="50,2 93,25 93,75 50,98 7,75 7,25" fill="url(#grad4)"></polygon>
        <polygon class="hexOuter" points="50,2 93,25 93,75 50,98 7,75 7,25" fill="none"></polygon>
        <polygon class="hexInner" points="50,6 89,27.5 89,72.5 50,94 11,72.5 11,27.5" fill="none"></polygon>
      </svg>

      <div class="safe">
        <div class="metricTitle jp">通信速度</div>

        <div class="valBox" style="gap:14px;">
          <div class="big seg" style="font-size: clamp(46px, 10.8vw, 84px); line-height:.92; max-height:1em;">
            <span id="dl">120</span><span class="unit">Mbps</span>
          </div>
          <div class="enLabel mono">DOWNLOAD</div>

          <div class="big seg" style="font-size: clamp(46px, 10.8vw, 84px); line-height:.92; max-height:1em;">
            <span id="ul">35</span><span class="unit">Mbps</span>
          </div>
          <div class="enLabel mono">UPLOAD</div>
        </div>

        <div class="bottom">
          <div class="gauge">
            <svg viewBox="0 0 100 100">
              <circle class="gBg" cx="50" cy="50" r="38"></circle>
              <circle class="gFg" id="gNET" cx="50" cy="50" r="38"></circle>
            </svg>
            <div class="gTxt en"><span id="gNETP">--</span>%</div>
          </div>
          <div class="statusLines mono">
            <div class="sline"><span>IFACE</span><span><b id="iface">WLAN0</b></span></div>
            <div class="sline"><span>PING</span><span><b id="ping">12</b> ms</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- STORAGE + SERVICES -->
    <section class="tile sev-ok" id="storTile">
      <svg class="hex" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="grad5" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="var(--f1)"/>
            <stop offset="1" stop-color="var(--f2)"/>
          </linearGradient>
        </defs>
        <polygon points="50,2 93,25 93,75 50,98 7,75 7,25" fill="url(#grad5)"></polygon>
        <polygon class="hexOuter" points="50,2 93,25 93,75 50,98 7,75 7,25" fill="none"></polygon>
        <polygon class="hexInner" points="50,6 89,27.5 89,72.5 50,94 11,72.5 11,27.5" fill="none"></polygon>
      </svg>

      <div class="safe">
        <div class="metricTitle jp">記憶容量</div>

        <div class="valBox" style="gap:12px;">
          <div class="bars mono">
            <div>SD CARD</div>
            <div class="bar"><i id="sdBar" style="width:31%"></i></div>
            <div id="sdText">USED 18.3 / 58.3 GB (31%)</div>

            <div style="height:6px"></div>

            <div>EXT HDD-01</div>
            <div class="bar"><i id="hddBar" style="width:21%"></i></div>
            <div id="hddText">USED 212 / 1000 GB (21%)</div>
          </div>

          <div class="svc mono">
            <div class="svcLine">
              <div class="svcName">GOJA-DENPO-SERVER</div>
              <div class="svcState" id="svcDenpo">稼働中...</div>
            </div>
            <div class="svcLine">
              <div class="svcName">GOJA-CLOUD-SERVER</div>
              <div class="svcState" id="svcCloud">稼働中...</div>
            </div>
          </div>
        </div>

        <div class="bottom">
          <div class="gauge">
            <svg viewBox="0 0 100 100">
              <circle class="gBg" cx="50" cy="50" r="38"></circle>
              <circle class="gFg" id="gST" cx="50" cy="50" r="38"></circle>
            </svg>
            <div class="gTxt en"><span id="gSTP">--</span>%</div>
          </div>
          <div class="statusLines mono">
            <div class="sline"><span>SYSTEM</span><span><b id="sysState">NORMAL</b></span></div>
            <div class="sline"><span>UPDATE</span><span><b id="update2">1.0</b> s</span></div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <div class="vignette"></div>

  <script>
    const el = (id)=>document.getElementById(id);
    const CIRC = 2 * Math.PI * 38;

    const tempTile = el("tempTile");
    const cpuTile  = el("cpuTile");
    const ramTile  = el("ramTile");
    const netTile  = el("netTile");
    const storTile = el("storTile");

    // ===== smoothing params =====
    const UPDATE_SEC = 1.0;      // target update interval
    const TAU = 2.2;             // smoothing time constant
    const MAX_STEP = {           // max change per second
      temp: 2.0,                 // ℃/s
      cpu:  6.0,                 // %/s
      ram:  4.0,                 // %/s
      dl:   25.0,                // Mbps/s
      ul:   15.0,                // Mbps/s
      ping: 3.0                  // ms/s
    };

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function setSev(tile, sev){
      tile.classList.remove("sev-ok","sev-caution","sev-warn");
      tile.classList.add(sev);
      const g = getComputedStyle(tile).getPropertyValue("--g");
      if(tile === tempTile) el("gTemp").style.stroke = g;
      if(tile === cpuTile)  el("gCPU").style.stroke  = g;
      if(tile === ramTile)  el("gRAM").style.stroke  = g;
      if(tile === netTile)  el("gNET").style.stroke  = g;
      if(tile === storTile) el("gST").style.stroke   = g;
    }

    function setGauge(circleId, labelId, p){
      p = clamp(p, 0, 100);
      const on = (CIRC * p/100);
      const off = (CIRC - on);
      el(circleId).style.strokeDasharray = `${on} ${off}`;
      el(labelId).textContent = String(Math.round(p)).padStart(2,'0');
    }

    function tempState(t){
      if(t >= 75) return {label:"EMERGENCY", sev:"sev-warn"};
      if(t >= 60) return {label:"CAUTION", sev:"sev-caution"};
      return {label:"NORMAL", sev:"sev-ok"};
    }
    function percentState(p){
      if(p >= 90) return {label:"EMERGENCY", sev:"sev-warn"};
      if(p >= 75) return {label:"CAUTION", sev:"sev-caution"};
      return {label:"NORMAL", sev:"sev-ok"};
    }
    function fmtUptime(sec){
      sec = Math.floor(sec);
      const h = String(Math.floor(sec/3600)).padStart(2,'0');
      const m = String(Math.floor((sec%3600)/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }

    // ===== smooth helpers =====
    function limitStep(current, target, maxPerSec, dt){
      const maxStep = maxPerSec * dt;
      const diff = target - current;
      if(Math.abs(diff) <= maxStep) return target;
      return current + Math.sign(diff) * maxStep;
    }
    function smooth(current, target, dt){
      const a = 1 - Math.exp(-dt / TAU);
      return current + a * (target - current);
    }

    // ===== services mock =====
    const services = { denpo:"active", cloud:"active" };
    function serviceLabel(st){
      if(st==="active") return "稼働中...";
      if(st==="restarting") return "再起動中...";
      return "停止";
    }
    function maybeFlipServices(){
      const r = Math.random();
      if(r < 0.008) services.denpo = "restarting";
      else if(r < 0.010) services.denpo = "inactive";
      else if(r < 0.020) services.denpo = "active";

      const c = Math.random();
      if(c < 0.006) services.cloud = "restarting";
      else if(c < 0.008) services.cloud = "inactive";
      else if(c < 0.018) services.cloud = "active";

      el("svcDenpo").textContent = serviceLabel(services.denpo);
      el("svcCloud").textContent = serviceLabel(services.cloud);
    }

    // ===== displayed values (smooth) =====
    const disp = {
      temp: 58, cpu: 41, ram: 63,
      dl: 120, ul: 35, ping: 12,
      sdP: 31, hddP: 21
    };

    // ===== target values =====
    const tgt = {...disp};

    let uptimeSec = 0;
    let last = performance.now();
    let acc = 0;

    function updateTargets(){
      tgt.temp = clamp(tgt.temp + (Math.random()*4 - 2), 42, 82);
      tgt.cpu  = clamp(tgt.cpu  + (Math.random()*14 - 7), 2, 98);
      tgt.ram  = clamp(tgt.ram  + (Math.random()*10 - 5), 5, 98);

      tgt.dl   = clamp(tgt.dl   + (Math.random()*40 - 20), 10, 300);
      tgt.ul   = clamp(tgt.ul   + (Math.random()*24 - 12),  5, 150);
      tgt.ping = clamp(tgt.ping + (Math.random()*6  -  3),  4, 60);

      tgt.sdP  = clamp(tgt.sdP  + (Math.random()*1.2 - 0.6), 10, 90);
      tgt.hddP = clamp(tgt.hddP + (Math.random()*1.0 - 0.5),  5, 95);

      maybeFlipServices();
    }

    function tick(){
      const now = performance.now();
      const dt = (now-last)/1000;
      last = now;

      uptimeSec += dt;
      acc += dt;

      el("updateAge").textContent = "1.0";
      el("update2").textContent = "1.0";
      el("uptime").textContent = fmtUptime(uptimeSec);

      if(acc >= UPDATE_SEC){
        while(acc >= UPDATE_SEC) acc -= UPDATE_SEC;
        updateTargets();
      }

      // smooth towards targets
      disp.temp = smooth(disp.temp, limitStep(disp.temp, tgt.temp, MAX_STEP.temp, dt), dt);
      disp.cpu  = smooth(disp.cpu,  limitStep(disp.cpu,  tgt.cpu,  MAX_STEP.cpu,  dt), dt);
      disp.ram  = smooth(disp.ram,  limitStep(disp.ram,  tgt.ram,  MAX_STEP.ram,  dt), dt);

      disp.dl   = smooth(disp.dl,   limitStep(disp.dl,   tgt.dl,   MAX_STEP.dl,   dt), dt);
      disp.ul   = smooth(disp.ul,   limitStep(disp.ul,   tgt.ul,   MAX_STEP.ul,   dt), dt);
      disp.ping = smooth(disp.ping, limitStep(disp.ping, tgt.ping, MAX_STEP.ping, dt), dt);

      disp.sdP  = smooth(disp.sdP,  limitStep(disp.sdP,  tgt.sdP,  0.6, dt), dt);
      disp.hddP = smooth(disp.hddP, limitStep(disp.hddP, tgt.hddP, 0.6, dt), dt);

      // render
      const tInt = Math.round(disp.temp);
      const cpuInt = Math.round(disp.cpu);
      const ramInt = Math.round(disp.ram);

      el("cpuTemp").textContent = String(tInt).padStart(2,'0');
      el("cpuUtil").textContent = String(cpuInt).padStart(2,'0');
      el("ramUtil").textContent = String(ramInt).padStart(2,'0');

      el("dl").textContent = String(Math.round(disp.dl)).padStart(2,'0');
      el("ul").textContent = String(Math.round(disp.ul)).padStart(2,'0');
      el("ping").textContent = String(Math.round(disp.ping)).padStart(2,'0');

      // severity
      const ts = tempState(tInt);
      el("tempState").textContent = ts.label;
      setSev(tempTile, ts.sev);

      const cs = percentState(cpuInt);
      el("cpuState").textContent = cs.label;
      setSev(cpuTile, cs.sev);

      const rs = percentState(ramInt);
      setSev(ramTile, rs.sev);

      // load + ram used
      const load = clamp((cpuInt/100)*2.5 + 0.2, 0.05, 3.8);
      el("loadAvg").textContent = load.toFixed(2);

      el("ramTotal").textContent = "4.0";
      el("ramUsed").textContent = (4.0 * ramInt/100).toFixed(1);

      // gauges
      setGauge("gTemp", "gTempP", clamp((tInt-30)/60*100, 0, 100));
      setGauge("gCPU",  "gCPUP",  cpuInt);
      setGauge("gRAM",  "gRAMP",  ramInt);
      setGauge("gNET",  "gNETP",  clamp((disp.dl/300)*100, 0, 100));

      // storage
      const sdP = clamp(disp.sdP, 0, 100);
      const hddP = clamp(disp.hddP, 0, 100);
      el("sdBar").style.width = `${sdP.toFixed(0)}%`;
      el("sdText").textContent = `USED ${(58.3*sdP/100).toFixed(1)} / 58.3 GB (${sdP.toFixed(0)}%)`;

      el("hddBar").style.width = `${hddP.toFixed(0)}%`;
      el("hddText").textContent = `USED ${(1000*hddP/100).toFixed(0)} / 1000 GB (${hddP.toFixed(0)}%)`;

      // storage severity by services
      const anyDown = (services.denpo==="inactive") || (services.cloud==="inactive");
      const anyRestart = (services.denpo==="restarting") || (services.cloud==="restarting");
      if(anyDown){ setSev(storTile, "sev-warn"); el("sysState").textContent="EMERGENCY"; }
      else if(anyRestart){ setSev(storTile, "sev-caution"); el("sysState").textContent="CAUTION"; }
      else { setSev(storTile, "sev-ok"); el("sysState").textContent="NORMAL"; }

      setGauge("gST","gSTP", (sdP + hddP)/2);

      requestAnimationFrame(tick);
    }

    // init
    setSev(tempTile,"sev-ok");
    setSev(cpuTile,"sev-ok");
    setSev(ramTile,"sev-ok");
    setSev(netTile,"sev-ok");
    setSev(storTile,"sev-ok");
    requestAnimationFrame(tick);
  </script>
</body>
</html>
